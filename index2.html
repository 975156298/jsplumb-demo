<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>jsplumnb</title>
    <style rel="stylesheet" type="text/css">
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            box-sizing: border-box;
        }

        .main {
            width: 100%;
            height: 100%;
            padding: 40px;
            display: flex;
            position: relative;
        }

        .main > .left {
            width: 400px;
            height: 100%;
            border-right: 2px solid #ff2321;
        }

        .main > .left > .item {
            width: 100px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 4px solid #3cb3ff;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .main > .right {
            height: 100%;
            width: calc(100% - 400px - 80px);
            border: 1px solid red;
            position: relative;
        }

        .main > .right > .item {
            position: absolute;
            width: 100px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 4px solid red;
        }

        .hide {
            display: none;
        }

        .jtk-endpoint {
            visibility: hidden !important;
        }

        .jtk-hover {
            visibility: visible !important;
        }

        .close {
            background: url(./icon_close.png) no-repeat;
            background-size: 100% 100%;
            width: 10px;
            height: 10px;
            position: absolute;
            right: 6px;
            top: 6px;
            cursor: pointer;
        }
    </style>
</head>
<body class="main">
<div id="model" data-id="" class="hide" style="position: absolute;top: 100px;left: 400px;z-index: 10;background-color: #409eff;width: 400px;height: 100px;padding: 20px 40px;">
    <div>
        <label><input name="Fruit" type="radio" value="a" />人 </label>
        <label><input name="Fruit" type="radio" value="b" />车 </label>
        <label><input name="Fruit" type="radio" value="c" />mac</label>
    </div>
    <div style="position: absolute;right: 40px;bottom: 20px;">
        <div onclick="getVal()">确定</div>
    </div>
</div>
<div id="left" class="left">
    <div id="yellowingPersonnelNode" class="item">
        <div>疑似涉黄人员</div>
    </div>
    <div id="yellowishHotelNode" class="item">
        <div>疑似涉黄旅馆</div>
    </div>
    <div id="realPopulationNode" class="item">
        <div>实有人口</div>
    </div>
    <div onclick="saves()">保存</div>
    <div onclick="loads()">加载</div>
    <div onclick="resetJsplumb()">重画</div>
</div>
<div id="right" class="right">
    <div id="start-a-1" status="" class="item start" style="left: 20px;top: 200px;">
        <div>开始</div>
        <div onclick="add()" style="background: url(icon_closed02.png) no-repeat center center;width: 20px;height: 20px;margin-left: 20px;"></div>
    </div>
</div>

<div id="start" status="" class="item start hide" style="left: 20px;top: 20px;">
    <div>开始</div>
    <div onclick="add()" style="background: url(icon_closed02.png) no-repeat center center;width: 20px;height: 20px;margin-left: 20px;"></div>
</div>

<div id="yellowingPersonnel" class="item hide">
    <div class="close hide"></div>
    <div>疑似涉黄人员</div>
</div>

<div id="yellowishHotel" class="item hide">
    <div>疑似涉黄旅馆</div>
</div>

<div id="realPopulation" class="item hide">
    <div>实有人口</div>
</div>

<div style="border: 1px solid red;border-radius: 50%;display: none">
    <p>椭圆形</p>
</div>

</body>
<script src="jquery-ui-1.12.1.custom/external/jquery/jquery.js"></script>
<script src="jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
<script src="jsplumb.js"></script>

<script src="./jsplumb-package.js"></script>
<script type="application/javascript">
    jsplumbPackage.init()
    function saves () {
        jsplumbPackage.saveJsplumb()
    }

    function loads () {
        jsplumbPackage.loadJsplumb()
    }

    function add () {
        if (jsplumbPackage.defaultParams.startMaxNum > jsplumbPackage.defaultParams.startNum) {
            let newId = jsplumbPackage.createDom('', '', 'start')
            // jsplumbPackage.addEndPoints(jsplumbPackage.defaultParams.connection, newId, ['TopCenter', 'RightMiddle', 'BottomCenter'], jsplumbPackage.common)
        } else {
         alert('该元素只允许添加' + jsplumbPackage.defaultParams.startMaxNum + '个')
        }
    }

    function getVal () {
        let getVal = $('input[name="Fruit"]:checked').val()
        console.log(getVal)
        let id = $('#model').data('id')
       $($('#' + id).find('div')[0]).text(getVal)
        $('#model').addClass('hide')
        let val = {
            a: 0,
            b: 1,
            c: 2
        }
        let splitId = id.split('-')
        let newId = splitId[0] + '-' + getVal + '-' + splitId[2]
        $('#' + id).attr('id', newId)
        jsplumbPackage.addEndPoints(newId, ['RightMiddle'], jsplumbPackage.setLineColor(jsplumbPackage.common, val[getVal]))
    }

    function bindDB () {
        $('#right').on('dblclick', '.start', function () {
            $('#model').data('id', $(this).attr('id'))
            $('#model').removeClass('hide')
        })
        /*$('#right').on('click', '.start', function () {
            let id = $(this).attr('id')
            console.log(id)
            let container = jsPlumb.getContainer(id)
            console.log(container)
            let aa = jsPlumb.selectEndpoints({source: id})
            aa.each(function(item) {
                console.log(item)
            })
            console.log(aa, aa.get())
        })*/
    }
    bindDB()
</script>

<!-- 手动连接时 -->
<!--<script type="application/javascript">
    // id => 代表节点id; anchors => 可用值： TopLeft、TopCenter、 TopRight、 RightMiddle、 BottomRight、 BottomCenter、 BottomLeft、 LeftMiddle、 Center
    // common => 通用配置
    function addEndPoint (id, anchors, common) {
        let connection  = jsPlumb.addEndpoint(id, {
            anchor: anchors,
            connectorOverlays: [["PlainArrow", {width: 10, length: 30, location: 1}]]
        }, common)
        return connection
    }

    function addEndPoints (connection, id, point = [], common) {
        common = {
            isSource: true,
            isTarget: true,
            // endpoint: ['Image', {src: './icon_close.png'}], 用于换图片
            ...common
        }
        for(let i = 0; i < point.length; i++) {
            connection[id] = addEndPoint(id, point[i], common)
            bindClick(connection[id])
        }
    }

    function setDragg(id) {
        jsPlumb.draggable(id, {containment: 'parent'})
        $('#' + id).draggable({containment: "parent"})
    }

    function bindClick (dom) {
        dom.bind('click', function (event) {
            console.log(event, '点击')
            console.log(event.anchor.type, event.elementId)
        })
    }

    // 用于移入显示、移出隐藏事情
    function globalMove () {
        $('#right').on('mouseenter', '.item', function () {
            let doms = $(this).nextAll('.jtk-endpoint')
            doms.each(function (index, item) {
                if (index > 3) {
                    return false
                }
                $(item).addClass('jtk-hover')
            })
            $(this).find('.close').removeClass('hide')
        })
        $('#right').on('mouseleave', '.item', function () {
            let doms = $(this).nextAll('.jtk-endpoint')
            doms.each(function (index, item) {
                if (index > 3) {
                    return false
                }
                $(item).removeClass('jtk-hover')
            })
            $(this).find('.close').addClass('hide')
        })
    }

    // 用于jsplumb 绑定全局事情 connection =》 代表连接事情 beforeDrop =》 连接之前作出判断是否可连接，fase不连接、true连接
    function jsPlumbBind () {
        jsPlumb.bind('connection', function (info) {
            console.log(info)
        })
        jsPlumb.bind('beforeDrop', function (info) {
            console.log(info)
            if (info.sourceId === info.targetId) {
                alert('不许连接')
                return false
            }
            return true
        })
    }

    //
    function globalBind () {
        jsPlumbBind()
        globalMove()
        $('#right').on('click', '.close',function () {
            removeDom(this)
        })
    }

    function createDom (ui, event, id, parentId = 'right') {
        let html = $('#' + id).clone()
        let newId = id + '-' + new Date().getTime()
        $(html).attr('id', newId)
        $(html).css({
            top: ui.position.top - $(event).offset().top,
            left: ui.position.left - $(event).offset().left,
            display: 'flex'
        })
        $('#' + parentId).append(html)
        return newId
    }

    function setLineColor (common, state = 0) {
        let color = ['#456', 'red', 'blue']
        let newCommon = deepClone(common)
        // newCommon.endpointStyle.fill = color[state]
        newCommon.connectorStyle.stroke = color[state]
        return newCommon
    }

    function deepClone(data) {
        let str = JSON.stringify(data)
        return JSON.parse(str)
    }

    function removeDom ( _this) {
        let id = $(_this).parent().attr('id')
        console.log(id)
        // jsPlumb.deleteConnectionsForElement(id) // 断开连接, 只会断开线，不会删除元素 deleteEndpoint
        jsPlumb.remove(id) // 会删除元素和线，但是官方说有bug。
    }


</script>

&lt;!&ndash; 通过数据加载 &ndash;&gt;
<script type="application/javascript">
    function dataCommon (state = 0) {
        let color = ['#456', 'red', 'blue']
        return {
            isSource: true,
            isTarget: true,
            connector: ['Flowchart'], // Bezier: 贝塞尔曲线  Flowchart: 具有90度转折点的流程线  StateMachine: 状态机  Straight: 直线
            paintStyle: { stroke: color[state], strokeWidth: 1 },
            // endpointStyle: { fill: color[state]},
            overlays: [["PlainArrow", {width: 10, length: 30, location: 1}]]
        }
    }
</script>

<script type="application/javascript">


    let connectorPaintStyle = {
        lineWidth: 4,
        stroke: "#61B7CF",
        joinstyle: "round",
        outlineColor: "white",
        outlineWidth: 2
    };
    // 鼠标悬浮在连接线上的样式
    let connectorHoverStyle = {
        lineWidth: 4,
        stroke: "#216477",
        outlineWidth: 2,
        outlineColor: "white"
    }
    let hollowCircle = {
        /*endpoint: ["Dot", {radius: 18}],  //端点的形状
        connectorStyle: connectorPaintStyle,//连接线的颜色，大小样式
        connectorHoverStyle: connectorHoverStyle,
        paintStyle: {
            strokeStyle: "#1e8151",
            fillStyle: "transparent",
            radius: 2,
            lineWidth: 2
        },        //端点的颜色样式
        //anchor: "AutoDefault",
        isSource: true,    //是否可以拖动（作为连线起点）
        connector: ["Flowchart", {stub: [40, 60], gap: 10, cornerRadius: 5, alwaysRespectStubs: true}],  //连接线的样式种类有[Bezier],[Flowchart],[StateMachine ],[Straight ]
        isTarget: true,    //是否可以放置（连线终点）
        maxConnections: -1,    // 设置连接点最多可以连接几条线
        connectorOverlays: [["Arrow", {width: 10, length: 10, location: 1}]]*/
    }

    let common = {
        connector: ['Flowchart'], // Bezier: 贝塞尔曲线  Flowchart: 具有90度转折点的流程线  StateMachine: 状态机  Straight: 直线
        endpointStyle: { fill : "#456" }, // 端点样式
        connectorStyle: {
            stroke: "#456"  // 连线样式
            // 'stroke-dasharray': '5,5' // 用于创建虚线
        }
    }
    let connection = {};

    function setDrag (id, scope = 'scope') {
        $("#" + id).children().draggable({
            helper: "clone",
            scope: scope, // scope 标识符，任何值都可以。
        });
    }

    function setDrop (id, scope = 'scope') {
        $('#' + id).droppable({
            scope: scope,
            drop: function (event, ui) {
                console.log(event, ui)
                let newId
                let name = ui.draggable[0].id
                switch (name) {
                    case 'yellowingPersonnelNode':
                        // jsPlumb.setContainer(id)
                        /*html = $('#yellowingPersonnel').clone()
                        newId = 'yellowingPersonnel' + new Date().getTime()
                        $(html).attr('id', newId)
                        $(html).css({
                            top: ui.position.top - $(this).offset().top,
                            left: ui.position.left - $(this).offset().left,
                            display: 'flex'
                        })
                        $('#' + id).append(html)
                        connection[newId] = jsPlumb.addEndpoint(newId, {
                            anchors: "TopCenter",
                            connectorOverlays: [
                                ["PlainArrow", {width: 10, length: 30, location: 1}]
                            ]
                        }, common)
                        jsPlumb.addEndpoint(newId, {
                            anchors: "RightMiddle",
                            connectorOverlays: [["PlainArrow", {width: 10, length: 30, location: 1}]]
                        }, common)
                        jsPlumb.addEndpoint(newId, {
                            anchors: "BottomCenter",
                            connectorOverlays: [["PlainArrow", {width: 10, length: 30, location: 1}]]
                        }, common)
                        jsPlumb.addEndpoint(newId, {
                            anchors: "LeftMiddle",
                            connectorOverlays: [["PlainArrow", {width: 10, length: 30, location: 1}]]
                        }, common)
                        // jsPlumb.addEndpoint(newId, hollowCircle);
                        connection[newId].bind('click', function (event) {
                            console.log(event)
                        })
                        jsPlumb.draggable(newId, {containment: 'parent'})
                        $('#' + newId).draggable({containment: "parent"})*/
                        newId = createDom(ui, this, 'yellowingPersonnel')
                        addEndPoints(connection, newId, ['TopCenter', 'RightMiddle', 'BottomCenter', 'LeftMiddle'], common)
                        setDragg(newId)
                        break;
                    case 'yellowishHotelNode':
                        newId = createDom(ui, this, 'yellowishHotel')
                        // addEndPoints(connection, newId, ['TopCenter', 'RightMiddle', 'BottomCenter', 'LeftMiddle'], setLineColor(common, 1))
                        addEndPoints(connection, newId, [['Left', 'Continuous']], setLineColor(common, 1))
                        setDragg(newId)
                        break;
                    case 'realPopulationNode':
                        newId = createDom(ui, this, 'realPopulation')
                        addEndPoints(connection, newId, ['TopCenter', 'RightMiddle', 'BottomCenter', 'LeftMiddle'], setLineColor(common, 2))
                        setDragg(newId)
                        break;
                }
            }
        })
    }

    /*function showDom (state = true) {
        if (state) {
            console.log(connection, 'true')
            connection.canvas.hidden = false
        } else {
            console.log(connection, 'false')
            connection.canvas.hidden = true
        }
    }*/
    setDrag('left')
    setDrop('right')
    globalBind()


    let connections = []
    let dom = []

    function saves () {
        dom = []
        connections = []
        saveJsplumb(connections, dom)
        console.log(connections, dom)
    }

    function loads () {
        console.log(connections)
        addDom(dom)
        loadJsplumb(connections)
    }

    function validDonExit (id, dom) {
        for (let i = 0; i < dom.length; i++) {
            if (dom[i].id === id) {
                return true
            }
        }
        return false
    }

    function saveJsplumb (connections, dom) {
        console.log('111111111111111111', jsPlumb.getConnections())
        let getDoms = $('#right > div')
        $.each(getDoms, function (index, item) {
            console.log($(item).attr('id'))
            let id = $(item).attr('id')
            if (id) {
                dom.push({
                    id: id,
                    node: $('#' + id)
                })
            }
        })

        $.each(jsPlumb.getConnections(), function (idx, connection) {
            console.log(idx,'idx============')
            console.log(connection)
            connections.push({
                status: idx,
                connectionId: connection.id,
                pageSourceId: connection.sourceId,
                pageTargetId: connection.targetId,
                anchors: $.map(connection.endpoints, function (endpoint) {
                    return [[endpoint.anchor.x,
                        endpoint.anchor.y,
                        endpoint.anchor.orientation[0],
                        endpoint.anchor.orientation[1],
                        endpoint.anchor.offsets[0],
                        endpoint.anchor.offsets[1]]];

                })
            });
        });
        $('#right > .item').each(function () {
            jsPlumb.remove($(this).attr('id'))
        })
    }

    function loadJsplumb (connections) {
        $.each(connections, function (index, elem) {
            jsPlumb.connect({
                source: elem.pageSourceId,
                target: elem.pageTargetId,
                anchors: elem.anchors,
                ...dataCommon(index)
            })
        })
    }

    function addDom (dom) {
        for( let i = 0; i < dom.length; i++) {
            $('#right').append(dom[i].node)
            addEndPoints(connection, dom[i].id, ['TopCenter', 'RightMiddle', 'BottomCenter', 'LeftMiddle'], setLineColor(common, i))
            setDragg(dom[i].id)
        }
        setDrag('left')
        setDrop('right')
        globalBind()
    }

    function resetJsplumb() {
        console.log('1111111111111')
        console.log(jsPlumb.repaintEverything())
    }

    // repaintEverything 重新绘制所有连接和端点

</script>-->
</html>
